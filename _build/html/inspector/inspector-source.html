

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2.3 inspector 源码分析 &mdash; ironic notes</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="ironic notes" href="../index.html"/>
        <link rel="next" title="3.0 IPA 介绍" href="../ipa/ipa.html"/>
        <link rel="prev" title="2.1 inspector 兼容 SDN lldp 报文" href="inspector-lldp.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> ironic notes
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ironic/preface.html">前言</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ironic/preface.html#id2">内容</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ironic/preface.html#id3">术语</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ironic/preface.html#id4">学习资料</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ironic/preface.html#id5">作者</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ironic/introduction.html">1.0 ironic 简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ironic/tftp.html">1.2 tftp 配置</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ironic/tftp.html#id1">安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ironic/tftp.html#id2">防火墙</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="inspector.html">2.0 inspector介绍</a><ul>
<li class="toctree-l2"><a class="reference internal" href="inspector.html#id1">inspector 安装</a><ul>
<li class="toctree-l3"><a class="reference internal" href="inspector.html#id2">创建数据库</a></li>
<li class="toctree-l3"><a class="reference internal" href="inspector.html#keystone">keystone 注册</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="inspector.html#id3">inspector 配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="inspector.html#dnsmasq">dnsmasq 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="inspector.html#tftp">tftp 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="inspector.html#ironic">ironic 配置</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="inspector.html#id4">组网说明</a></li>
<li class="toctree-l2"><a class="reference internal" href="inspector.html#id5">说明</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="inspector-lldp.html">2.1 inspector 兼容 SDN lldp 报文</a><ul>
<li class="toctree-l2"><a class="reference internal" href="inspector-lldp.html#lldp">lldp 介绍</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="">2.3 inspector 源码分析</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ironic">ironic 处理阶段</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">inspector处理阶段</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ipa">IPA 阶段</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">inspector主机上报阶段</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ipa/ipa.html">3.0 IPA 介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ironic/images.html">4.0 ironic 映像</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ironic/images.html#deploy">deploy 映像</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../ironic/images.html#coreos">coreos 映像</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ironic/images.html#dib">dib 映像</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ironic/images.html#id1">映像密码</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../ironic/images.html#user">user 映像</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ironic/vbmc.html">5.2 virtualbmc使用</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ironic/vbmc.html#id1">virtualbmc 安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ironic/vbmc.html#id2">virtualbmc 使用</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ironic/vbmc.html#id3">常用命令</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ironic/vbmc.html#id4">说明</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">ironic notes</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>2.3 inspector 源码分析</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="inspector">
<h1>2.3 inspector 源码分析<a class="headerlink" href="#inspector" title="Permalink to this headline">¶</a></h1>
<p>ironic-inspector 使用 flask 框架来编写的。flask 是一个轻量级
的 python web 框架， 详细资料可以查看: <a class="reference external" href="http://flask.pocoo.org/">http://flask.pocoo.org/</a></p>
<div class="section" id="ironic">
<h2>ironic 处理阶段<a class="headerlink" href="#ironic" title="Permalink to this headline">¶</a></h2>
<p>我们首先通过 cli 来触发 ironic inspector 流程。</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>ironic node-set-provision-state &lt;node_uuid&gt; manage
ironic node-set-provision-state &lt;node_uuid&gt; inspect
</pre></div>
</div>
<p>我们知道 openstack 组件之前的调用都是通过 restful 接口来完成的，
而组件内部是通过 rpc 调用来完成的。</p>
<p>上面的 cli 会发送 PUT 请求到 <code class="docutils literal"><span class="pre">/v1/nodes/{node_ident}/provision</span></code> ,
ironic-api 收到这个请求后会根据 body 的 <code class="docutils literal"><span class="pre">target</span></code> 字段做处理：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># ironic/api/controllers/v1/node.py</span>
<span class="k">def</span> <span class="nf">provision</span><span class="p">():</span>
<span class="o">...</span>
    <span class="k">elif</span> <span class="n">target</span> <span class="o">==</span> <span class="n">ir_state</span><span class="o">.</span><span class="n">VERBS</span><span class="p">[</span><span class="s1">&#39;inspect&#39;</span><span class="p">]:</span>
        <span class="n">pecan</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">rpcapi</span><span class="o">.</span><span class="n">inspect_hardware</span><span class="p">()</span>
</pre></div>
</div>
<p>然后 ironic 通过 rpc 调用 inspect_hardware 方法。然后通过发送 http 请求
到 ironic-inspector。inspect 的具体实现是跟 driver 有关，在
driver.inspect.inspect_hardware 中。</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># ironic/drivers/modules/inspector.py</span>
<span class="k">def</span> <span class="nf">_start_inspection</span><span class="p">(</span><span class="n">node_uuid</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_call_inspector</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">introspect</span><span class="p">,</span> <span class="n">node_uuid</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="o">...</span>

<span class="c1"># ironic_inspector_client/client.py</span>
<span class="k">def</span> <span class="nf">introspect</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">auth_token</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">new_ipmi_password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">new_ipmi_username</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">api_version</span><span class="o">=</span><span class="n">DEFAULT_API_VERSION</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">v1</span><span class="o">.</span><span class="n">ClientV1</span><span class="p">(</span><span class="n">api_version</span><span class="o">=</span><span class="n">api_version</span><span class="p">,</span> <span class="n">auth_token</span><span class="o">=</span><span class="n">auth_token</span><span class="p">,</span>
                    <span class="n">inspector_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">introspect</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">new_ipmi_username</span><span class="o">=</span><span class="n">new_ipmi_username</span><span class="p">,</span>
                        <span class="n">new_ipmi_password</span><span class="o">=</span><span class="n">new_ipmi_password</span><span class="p">)</span>

<span class="c1"># ironic_inspector_client/v1.py</span>
<span class="k">def</span> <span class="nf">introspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">new_ipmi_password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">new_ipmi_username</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;new_ipmi_username&#39;</span><span class="p">:</span> <span class="n">new_ipmi_username</span><span class="p">,</span>
              <span class="s1">&#39;new_ipmi_password&#39;</span><span class="p">:</span> <span class="n">new_ipmi_password</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;/introspection/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">uuid</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
<p>通过上面的代码，我们可以看到 ironic 发送了 post 请求到 <code class="docutils literal"><span class="pre">/introspection/&lt;uuid&gt;</span></code> 。
下面流程就到了 inspector 了。</p>
</div>
<div class="section" id="id1">
<h2>inspector处理阶段<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>ironic-inspector 的 restful api 实现在 <code class="docutils literal"><span class="pre">main.py</span></code> 中，我们首先根据
url 找到对应的函数：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># main.py</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/v1/introspection/&lt;uuid&gt;&#39;</span><span class="p">)</span>
<span class="nd">@convert_exceptions</span>
<span class="k">def</span> <span class="nf">api_introspection</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">introspect</span><span class="o">.</span><span class="n">introspect</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span>
                          <span class="n">new_ipmi_credentials</span><span class="o">=</span><span class="n">new_ipmi_credentails</span><span class="p">,</span>
                          <span class="n">token</span><span class="o">=</span><span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;X-Auth-Token&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">202</span>
</pre></div>
</div>
<p>再看看introspect的具体实现：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># introspect.py</span>
<span class="k">def</span> <span class="nf">introspect</span><span class="p">():</span>
<span class="n">node_info</span> <span class="o">=</span> <span class="n">node_cache</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                <span class="n">bmc_address</span><span class="o">=</span><span class="n">bmc_address</span><span class="p">,</span>
                                <span class="n">ironic</span><span class="o">=</span><span class="n">ironic</span><span class="p">)</span>
<span class="n">future</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">executor</span><span class="p">()</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_background_introspect</span><span class="p">,</span> <span class="n">ironic</span><span class="p">,</span> <span class="n">node_info</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>introspect函数先是更新了ipmi信息，然后在inspector的node表里添加一条记录，
另外在attributes表里添加bmc_address信息。最终后台调用
_background_introspect做主机发现。</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># introspect.py</span>
<span class="k">def</span> <span class="nf">_background_introspect_locked</span><span class="p">(</span><span class="n">ironic</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ironic</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set_boot_device</span><span class="p">(</span><span class="n">node_info</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;pxe&#39;</span><span class="p">,</span>
                                    <span class="n">persistent</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ironic</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set_power_state</span><span class="p">(</span><span class="n">node_info</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;reboot&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>我们在已经配置好了裸机，并在/tftpboot/pxelinux.cfg/default设置了如下信息:</p>
<div class="highlight-shell"><div class="highlight"><pre><span></span>default introspect
label introspect
kernel ironic-agent.vmlinuz
append <span class="nv">initrd</span><span class="o">=</span>ironic-agent.initramfs ipa-inspection-callback-url<span class="o">=</span>http://192.168.2.2:5050/v1/continue ipa-inspection-collectors<span class="o">=</span>default,logs systemd.journald.forward_to_console<span class="o">=</span>no
ipappend <span class="m">3</span>
</pre></div>
</div>
</div>
<div class="section" id="ipa">
<h2>IPA 阶段<a class="headerlink" href="#ipa" title="Permalink to this headline">¶</a></h2>
<p>裸机从小系统启动之后，会启动ironic-python-agent服务。
该服务会收集裸机的硬件信息，并发送到
ipa-inspection-callback-url指定的url。</p>
</div>
<div class="section" id="id2">
<h2>inspector主机上报阶段<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>先看看inspector怎么处理ipa上报的数据：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># main.py</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/v1/continue&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="n">post</span><span class="p">])</span>
<span class="nd">@convert_exceptions</span>
<span class="k">def</span> <span class="nf">api_continue</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="c1"># process.py</span>
<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">introspection_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process data from the ramdisk.</span>

<span class="sd">    This function heavily relies on the hooks to do the actual data processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hooks</span> <span class="o">=</span> <span class="n">plugins_base</span><span class="o">.</span><span class="n">processing_hooks_manager</span><span class="p">()</span>
    <span class="n">failures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">hook_ext</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hook_ext</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">before_processing</span><span class="p">(</span><span class="n">introspection_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">utils</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="o">...</span>
    <span class="c1"># 根据ipmi_address和macs获取inpsector node</span>
    <span class="n">node_info</span> <span class="o">=</span> <span class="n">_finde_node_info</span><span class="p">(</span><span class="n">introspection_data</span><span class="p">,</span> <span class="n">failures</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">node_info</span><span class="o">.</span><span class="n">node</span><span class="p">()</span>
        <span class="o">...</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_process_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">introspection_data</span><span class="p">,</span> <span class="n">node_info</span><span class="p">)</span>
</pre></div>
</div>
<p>我们可以看到这里数据是交由process出来，而process函数又调用各种钩子来出来ipa数据。
接着根据ipmi_address查找对应的inspector node，再根据获取到的uuid来得到
ironic node，交由_process_node()函数处理。</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># process.py</span>
<span class="k">def</span> <span class="nf">_process_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">introspection_data</span><span class="p">,</span> <span class="n">node_info</span><span class="p">):</span>
    <span class="n">ir_utils</span><span class="o">.</span><span class="n">check_provision_state</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">node_info</span><span class="o">.</span><span class="n">create_ports</span><span class="p">(</span><span class="n">introspection_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;macs&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">())</span>
    <span class="n">_run_post_hooks</span><span class="p">(</span><span class="n">node_inof</span><span class="p">,</span> <span class="n">introspection_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">CONF</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">store_data</span> <span class="o">==</span> <span class="s1">&#39;switf&#39;</span><span class="p">:</span>
        <span class="n">stored_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">introspection_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_STORAGE_EXCLUDE_KEYS</span><span class="p">}</span>
        <span class="n">swift_object_name</span> <span class="o">=</span> <span class="n">switf</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">store_introspection_data</span><span class="p">(</span><span class="n">stored_data</span><span class="p">,</span>
                                                                 <span class="n">node_info</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
    <span class="n">ironic</span> <span class="o">=</span> <span class="n">ir_utils</span><span class="o">.</span><span class="n">get_client</span><span class="p">()</span>
    <span class="n">firewall</span><span class="o">.</span><span class="n">update_filters</span><span class="p">(</span><span class="n">ironic</span><span class="p">)</span>

    <span class="n">node_info</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">()</span>
    <span class="n">rules</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">node_info</span><span class="p">,</span> <span class="n">introspection_data</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">executor</span><span class="p">()</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">_finish</span><span class="p">,</span> <span class="n">ironic</span><span class="p">,</span> <span class="n">node_info</span><span class="p">,</span> <span class="n">introspection_data</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_finish</span><span class="p">(</span><span class="n">ironic</span><span class="p">,</span> <span class="n">node_info</span><span class="p">,</span> <span class="n">introspection_data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ironic</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">set_power_state</span><span class="p">(</span><span class="n">node_info</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">node_info</span><span class="o">.</span><span class="n">finished</span><span class="p">()</span>
</pre></div>
</div>
<p>我们可以看到，如果配置了store_data=swift，inspector会把ipa上报的数据
存储到swift中。最后的 node_info.finished()是删除inspector数据库中已
完成的数据。</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../ipa/ipa.html" class="btn btn-neutral float-right" title="3.0 IPA 介绍" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="inspector-lldp.html" class="btn btn-neutral" title="2.1 inspector 兼容 SDN lldp 报文" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, liekkas.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>